<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>Kagamine</title>
    <meta name="keywords" content="镜音双子,镜音连,镜音连,Kagamine,Rin,Len">
    <meta name="description" content="如果天使有声音，那么一定是镜音的天籁！">
    <link rel="stylesheet" href="https://static-1.llilii.cn/libs/mdui/css/mdui.min.css" />
    <script src="https://static-1.llilii.cn/libs/mdui/js/mdui.min.js"></script>
    <script src="https://static-1.llilii.cn/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://static-1.llilii.cn/libs/md5/jquery.md5.js"></script>
    <script src="/js/console-image.js"></script>
</head>

<body class="mdui-bottom-nav-fixed mdui-theme-primary-teal mdui-theme-accent-pink mdui-theme-layout-auto mdui-loaded">
    <div style="display: none;" id="isLoading" class="mdui-progress">
        <div class="mdui-progress-indeterminate"></div>
    </div>
    <div id="page-index" class="mdui-container" style="max-width: 800px;">
        <h1 class="doc-title mdui-text-color-theme">Kagamine</h1>
        <div class="doc-chapter">
            <div class="mdui-typo">
                <p>在这里，你可以以瀑布流的形式查看图片</p>
            </div>
        </div><br>
        <div class="mdui-row-xs-2 mdui-row-gapless">
            <div class="mdui-col" id="imageBoxCol-0"></div>
            <div class="mdui-col" id="imageBoxCol-1">
                <div id="imgBoxId-main" class="mdui-card mdui-hoverable">
                    <div class="mdui-card-content">
                        直接显示图片：
                        <label class="mdui-switch">
                            <input id="showImageDirect" type="checkbox" />
                            <i class="mdui-switch-icon"></i>
                        </label>
                        <br> 显示加载进度条：
                        <label class="mdui-switch">
                            <input id="showLoadingStatus" type="checkbox" checked />
                            <i class="mdui-switch-icon"></i>
                        </label>
                        <br> 自动加载图片补位：
                        <label class="mdui-switch">
                            <input id="autoLoadImages" type="checkbox" checked />
                            <i class="mdui-switch-icon"></i>
                        </label>
                        <div class="mdui-panel mdui-panel-popout" mdui-panel>
                            <div class="mdui-panel-item">
                                <div class="mdui-panel-item-header">
                                    <div class="mdui-panel-item-title">高级设置</div>
                                    <i class="mdui-panel-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
                                </div>
                                <div class="mdui-panel-item-body">
                                    <div class="mdui-textfield mdui-textfield-floating-label">
                                        <label class="mdui-textfield-label">图像列表</label>
                                        <input id="imgListURL" class="mdui-textfield-input" type="text" />
                                    </div>
                                    <div class="mdui-textfield mdui-textfield-floating-label">
                                        <label class="mdui-textfield-label">图像基础地址</label>
                                        <input id="imgBaseURL" class="mdui-textfield-input" type="text" />
                                    </div>
                                    <div class="mdui-panel-item-actions">
                                        <button class="mdui-btn mdui-ripple" mdui-panel-item-close>关闭</button>
                                        <button onclick="saveAdvancedSettings()"
                                            class="mdui-btn mdui-ripple">保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><br>
        <center>
            <button onclick="loadMore()"
                class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent">加载更多~</button>
        </center>
    </div>
    <div style="display: none;">
        <div id="imageBoxTemplate">
            <div id="imgBoxId-main" style="display: none;" class="mdui-card mdui-hoverable">
                <div class="mdui-card-media">
                    <img onclick="window.open(this.src)" id='imgBoxId-imageSrc' src="" />
                    <div class="mdui-card-menu">
                        <button onclick="like('imgBoxId','image-name')"
                            class="mdui-btn mdui-btn-icon mdui-color-theme-accent mdui-ripple">
                            <i class="mdui-icon material-icons">favorite</i>
                        </button>
                        &nbsp;
                        <div class="mdui-float-right mdui-card-primary-subtitle">
                            <div id="imgBoxId-likes">0</div>
                        </div>
                    </div>
                </div>
                <div id='imgBoxId-loadingBox'>
                    <div id='imgBoxId-loadingBoxHeight' class="mdui-card-content">
                        <h2>LOADING</h2>
                        <br>
                        <div class="mdui-progress">
                            <div id='imgBoxId-loadingStatus' class="mdui-progress-determinate" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>
<script>
    window.loadingCount = 0
    if (getCookie("showLoadingStatus") == "") {
        setDefaultSettings()
    } else {
        window.showLoadingStatus = (getCookie("showLoadingStatus") == "true")
        window.showImageDirect = (getCookie("showImageDirect") == "true")
        window.autoLoadImages = (getCookie("autoLoadImages") == "true")
        $("#showLoadingStatus").attr("checked", showLoadingStatus)
        $("#autoLoadImages").attr("checked", autoLoadImages)
        $("#showImageDirect").attr("checked", showImageDirect)
        $("#showLoadingStatus").attr("disabled", showImageDirect)
        window.imgListURL = getCookie("imgListURL")
        window.imgBaseURL = getCookie("imgBaseURL")
        $("#imgListURL").val(getCookie("imgListURL"))
        $("#imgBaseURL").val(getCookie("imgBaseURL"))
    }
    window.loadImageNumber = 10
    if (imgListURL == "" || imgListURL == null || imgListURL == undefined) {
        setDefaultSettings()
        mdui.snackbar({
            message: '加载图片列表失败！请刷新重试！',
            position: 'right-top'
        });
    } else {
        timestamp = Date.parse(new Date()) / 1000
        key = $.md5('KAGAMINE LEN LOVE RIN !' + timestamp)
        request_api("get_likes", { key: key, timestamp: timestamp }, function (rdata) {
            window.likes = rdata.data
            $.get(imgListURL, function (rdata) {
                window.imgList = rdata
                loadMore()
                setInterval(function () {
                    if (loadingCount == 0) {
                        autoLoadImage()
                    }
                }, 6000);
            })
        }, true, false, false)

    }

    function request_api(functionName, args, callback, showResults, refreshPageWhenSuccess, disableBtnId) {
        $(disableBtnId).attr("disabled", true);
        setTimeout(function () {
            $(disableBtnId).attr("disabled", false);
        }, 200000)
        $("#isLoading").show(100)
        $.ajax({
            type: 'post',
            url: 'https://api.llilii.cn/kagamine/' + functionName + '.php',
            data: args,
            dataType: 'json',
            success: function (rdata) {
                if (showResults) {
                    mdui.snackbar({
                        message: rdata.msg,
                        position: 'right-top'
                    })
                }
                if (refreshPageWhenSuccess & rdata.code == 1) {
                    $.pjax.reload({
                        container: "#pjax-container"
                    })
                }
                $("#isLoading").hide(100)
                $(disableBtnId).attr("disabled", false)
                if (callback) {
                    callback(rdata)
                }
            },
            error: function (data) {
                $("#isLoading").hide(100)
                $(disableBtnId).attr("disabled", false)
                mdui.snackbar({
                    message: "请求接口[" + functionName + "]时，出现了一个致命错误！",
                    position: 'right-top'
                })
            },
        })
    }

    function setDefaultSettings() {
        window.showLoadingStatus = true
        window.showImageDirect = false
        window.autoLoadImages = true
        window.imgListURL = "https://static-1.llilii.cn/json/img_list.json"
        window.imgBaseURL = "https://img-1.llilii.cn/kagamine/"
        $("#imgListURL").val(imgListURL)
        $("#imgBaseURL").val(imgBaseURL)
        setCookie("showImageDirect", $("#showImageDirect").prop("checked"), 30)
        setCookie("showLoadingStatus", $("#showLoadingStatus").prop("checked"), 30)
        setCookie("autoLoadImages", $("#autoLoadImages").prop("checked"), 30)
        setCookie("imgListURL", imgListURL, 30)
        setCookie("imgBaseURL", imgBaseURL, 30)
    }

    function saveAdvancedSettings() {
        window.imgListURL = $("#imgListURL").val()
        window.imgBaseURL = $("#imgBaseURL").val()
        setCookie("imgListURL", imgListURL, 30)
        setCookie("imgBaseURL", imgBaseURL, 30)
        $.get(imgListURL, function (rdata) {
            window.imgList = rdata
        });
        mdui.snackbar({
            message: '保存成功！',
            position: 'right-top'
        });
    }

    function loadMore() {
        loadingCount += loadImageNumber - 1
        for (i = 0; i < loadImageNumber - 1; i++) {
            imgBoxCreate(i % 2)
        }
        if (showImageDirect) {
            autoLoadImage()
        } else {
            setTimeout(function () {
                autoLoadImage()
            }, 6000);
        }
    }

    function autoLoadImage() {
        loadingCount += 1
        if ($("#imageBoxCol-0").height() - $("#imageBoxCol-1").height() > 0) {
            imgBoxCreate(1)
        } else {
            imgBoxCreate(0)
        }
    }

    $("#autoLoadImages").click(function () {
        setCookie("autoLoadImages", $("#autoLoadImages").prop("checked"), 30)
        autoLoadImages = $("#autoLoadImages").prop("checked")
    })

    $("#showLoadingStatus").click(function () {
        setCookie("showLoadingStatus", $("#showLoadingStatus").prop("checked"), 30)
        showLoadingStatus = $("#showLoadingStatus").prop("checked")
    })

    $("#showImageDirect").click(function () {
        setCookie("showImageDirect", $("#showImageDirect").prop("checked"), 30)
        showImageDirect = $("#showImageDirect").prop("checked")
        $("#showLoadingStatus").attr("disabled", showImageDirect)
    })


    function randomNumBoth(min, max) {
        var range = max - min;
        var rand = Math.random();
        var num = min + Math.round(rand * range);
        return num;
    }

    function isMobile() {
        var userAgentInfo = navigator.userAgent;
        var mobileAgents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
        var mobileFlag = false;
        for (var v = 0; v < mobileAgents.length; v++) {
            if (userAgentInfo.indexOf(mobileAgents[v]) > 0) {
                mobileFlag = true;
                break;
            }
        }
        var screenWidth = window.screen.width;
        var screenHeight = window.screen.height;
        if (screenWidth < 500 && screenHeight < 800) {
            mobileFlag = true;
        }
        return mobileFlag;
    }

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    function loadImage(imgURL, imgBoxId, callback) {
        loadingStatus()
        var xhr = new XMLHttpRequest();
        xhr.open('GET', imgURL);
        xhr.onprogress = function (event) {
            if (event.lengthComputable) {
                $("#" + imgBoxId.toString() + "-loadingStatus").css("width", parseInt((event.loaded / event.total) * 100).toString() + "%")
            }
        };
        xhr.onreadystatechange = function () {
            switch (xhr.readyState) {
                case 4:
                    if (loadingCount > 0) {
                        loadingCount -= 1
                    }
                    loadingStatus()
                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                        callback(imgBoxId, imgURL)
                    } else {
                        mdui.snackbar({
                            message: '抱歉，图片加载失败！',
                            position: 'left-top'
                        });
                    }
            }
        };
        xhr.send();
    }

    function loadingStatus() {
        if (loadingCount > 0) {
            $("#isLoading").show(200)
        } else {
            $("#isLoading").hide(200)
        }
    }

    function like(imagebox_id, image_name) {
        timestamp = Date.parse(new Date()) / 1000
        key = $.md5('KAGAMINE LEN LOVE RIN !' + timestamp)
        request_api("like_image", { image_name: image_name, timestamp: timestamp, key: key }, function (rdata) {
            $("#" + imagebox_id.toString() + "-likes").text(rdata.likes);
        }, true, false, false)
    }

    function imgBoxCreate(colId) {
        imgBoxId = randomNumBoth(100000, 99999999)
        imageBoxTemplate = $("#imageBoxTemplate").html()
        image_id = randomNumBoth(0, parseInt(imgList['file_num']) - 1)
        image_name = imgList['file_name'][image_id]
        imgURL = imgBaseURL + image_name
        imageBoxTemplate = imageBoxTemplate.replaceAll("imgBoxId", imgBoxId).replaceAll("image-name", image_name)
        $("#imageBoxCol-" + colId.toString()).append(imageBoxTemplate)
        $("#" + imgBoxId.toString() + "-imageSrc").attr("src", imgURL);
        if (likes[image_name] != undefined) {
            $("#" + imgBoxId.toString() + "-likes").text(likes[image_name]);
        }
        $("#" + imgBoxId.toString() + "-imageSrc").hide()
        if (isMobile()) {
            $("#" + imgBoxId.toString() + "-loadingBox").css("height", randomNumBoth(100, 200).toString() + "px")
        } else {
            $("#" + imgBoxId.toString() + "-loadingBox").css("height", randomNumBoth(400, 600).toString() + "px")
        }
        if (showImageDirect) {
            $("#" + imgBoxId.toString() + "-imageSrc").show()
            $("#" + imgBoxId.toString() + "-loadingBox").hide()
            $("#" + imgBoxId.toString() + "-main").show(200)
        } else {
            if (showLoadingStatus) {
                $("#" + imgBoxId.toString() + "-main").show(200)
            }
            loadImage(imgURL, imgBoxId, function (imgBoxId, imgURL) {
                if (!showLoadingStatus) {
                    $("#" + imgBoxId.toString() + "-main").show(200)
                }
                $("#" + imgBoxId.toString() + "-imageSrc").show()
                $("#" + imgBoxId.toString() + "-loadingBox").hide()
            })
        }
    }
</script>